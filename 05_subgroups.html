
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Subgroups &#8212; Recidivism Case Study</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '05_subgroups';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Recidivism Case Study</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="index.html">
                    Recidivism Case Study
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_classification.html">Predicting Crime</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_calibration.html">Algorithmic Fairness</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_fairness.html">Fairness by Gender</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/AllenDowney/RecidivismCaseStudy" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/05_subgroups.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Subgroups</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-reference-class-problem">The reference class problem</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#groups">Groups</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intersections">Intersections</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reverse-engineering">Reverse engineering</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="subgroups">
<h1>Subgroups<a class="headerlink" href="#subgroups" title="Link to this heading">#</a></h1>
<p>This is the fifth in a series of notebooks that make up a <a class="reference external" href="https://allendowney.github.io/RecidivismCaseStudy/">case study on classification and algorithmic fairness</a>.
This case study is part of the <a class="reference external" href="https://allendowney.github.io/ElementsOfDataScience/"><em>Elements of Data Science</em></a> curriculum.
<a class="reference external" href="https://colab.research.google.com/github/AllenDowney/RecidivismCaseStudy/blob/v1/05_subgroups.ipynb">Click here to run this notebook on Colab</a>.</p>
<section id="data">
<h2>Data<a class="headerlink" href="#data" title="Link to this heading">#</a></h2>
<p>The authors of “Machine Bias” published their data and analysis in <a class="reference external" href="https://github.com/propublica/compas-analysis">this repository</a>.</p>
<p>The terms of use for the data <a class="reference external" href="https://www.propublica.org/datastore/terms">are here</a>.  In compliance with those terms, I am not redistributing the data.  The following cell downloads the data file we’ll use directly from their repository.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">download</span><span class="p">(</span>
    <span class="s2">&quot;https://github.com/propublica/compas-analysis/raw/master/compas-scores-two-years.csv&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 2;
                var nbb_unformatted_code = "download(\n    \"https://github.com/propublica/compas-analysis/raw/master/compas-scores-two-years.csv\"\n)";
                var nbb_formatted_code = "download(\n    \"https://github.com/propublica/compas-analysis/raw/master/compas-scores-two-years.csv\"\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>The following cell read the data file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">cp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;compas-scores-two-years.csv&quot;</span><span class="p">)</span>
<span class="n">cp</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(7214, 53)
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 3;
                var nbb_unformatted_code = "import pandas as pd\n\ncp = pd.read_csv(\"compas-scores-two-years.csv\")\ncp.shape";
                var nbb_formatted_code = "import pandas as pd\n\ncp = pd.read_csv(\"compas-scores-two-years.csv\")\ncp.shape";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
</section>
<section id="the-reference-class-problem">
<h2>The reference class problem<a class="headerlink" href="#the-reference-class-problem" title="Link to this heading">#</a></h2>
<p>In the first notebook we replicated the analysis in the ProPublica article and computed various metrics of accuracy for white and black defendants.  We found that the predictive values (PPV and NPV) were similar for the two groups, but the error rates (FPR and FNR) were substantially different.</p>
<p>In the previous notebook, we ran the same analysis for male and female defendants and found the opposite pattern: the error rates are about the same, but the predictive values are different.</p>
<p>Neither scenario seems completely fair.  Comparing black and white defendants:</p>
<ul class="simple">
<li><p>Among non-recidivists, black defendants were more likely to be classified as high risk (false positive).</p></li>
<li><p>Among recidivists, white defendants were more likely to be classified as low risk (false negative).</p></li>
</ul>
<p>Comparing male and female defendants:</p>
<ul class="simple">
<li><p>Among defendants classified as high risk, female defendants were less likely to recidivate; that is, the test has lower PPV for women.</p></li>
<li><p>Among defendants classified as low risk, male defendants were less likely to “survive”; that is, the test has lower NPV for men.</p></li>
</ul>
<p>So it seems like we can’t win.  If predictive values are the same for all groups, error rates are not (in general).  And if error rates are the same, predictive values are not.</p>
<p>Nevertheless, the designers of a test like COMPAS can make trade-offs among these kinds of errors.  And that raises two questions I would like to explore:</p>
<ol class="arabic simple">
<li><p>What kind of fairness is COMPAS designed to achieve?  Are they trying to make predictive value the same for all groups?  Or error rates?  Or some compromise?</p></li>
<li><p>What kind of fairness <em>should</em> a test like COMPAS achieve?</p></li>
</ol>
<p>To explore the first question, I will compute accuracy metrics for defendants grouped by age, race, and sex, and for the intersections of these groups (explained below).</p>
</section>
<section id="groups">
<h2>Groups<a class="headerlink" href="#groups" title="Link to this heading">#</a></h2>
<p>The following function takes a DataFrame containing COMPAS data and a list of variables to group by.  It returns a table with one row for each group and one column for each accuracy metric.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">make_matrix</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">compute_metrics</span>


<span class="k">def</span> <span class="nf">make_table</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">group_vars</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Make a table of metrics for each subgroup.</span>

<span class="sd">    cp: DataFrame of COMPAS data</span>
<span class="sd">    group_vars: string or list of variable names to group by</span>

<span class="sd">    returns: DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># count the number of defendants in each group</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_vars</span><span class="p">)</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="n">grouped</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

    <span class="c1"># make the table</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FPR&quot;</span><span class="p">,</span> <span class="s2">&quot;FNR&quot;</span><span class="p">,</span> <span class="s2">&quot;PPV&quot;</span><span class="p">,</span> <span class="s2">&quot;NPV&quot;</span><span class="p">,</span> <span class="s2">&quot;Prevalence&quot;</span><span class="p">]</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">counts</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># fill in the table</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">make_matrix</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">compute_metrics</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;Percent&quot;</span><span class="p">]</span>

    <span class="n">table</span><span class="p">[</span><span class="s2">&quot;Count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>
    <span class="k">return</span> <span class="n">table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 4;
                var nbb_unformatted_code = "from utils import make_matrix\nfrom utils import compute_metrics\n\n\ndef make_table(cp, group_vars):\n    \"\"\"Make a table of metrics for each subgroup.\n\n    cp: DataFrame of COMPAS data\n    group_vars: string or list of variable names to group by\n\n    returns: DataFrame\n    \"\"\"\n    # count the number of defendants in each group\n    grouped = cp.groupby(group_vars)\n    counts = grouped[\"id\"].count()\n\n    # make the table\n    columns = [\"FPR\", \"FNR\", \"PPV\", \"NPV\", \"Prevalence\"]\n    table = pd.DataFrame(index=counts.index, columns=columns, dtype=float)\n\n    # fill in the table\n    for name, group in grouped:\n        if len(group) < 50:\n            continue\n        m = make_matrix(group)\n        metrics = compute_metrics(m)\n        table.loc[name] = metrics[\"Percent\"]\n\n    table[\"Count\"] = counts\n    return table";
                var nbb_formatted_code = "from utils import make_matrix\nfrom utils import compute_metrics\n\n\ndef make_table(cp, group_vars):\n    \"\"\"Make a table of metrics for each subgroup.\n\n    cp: DataFrame of COMPAS data\n    group_vars: string or list of variable names to group by\n\n    returns: DataFrame\n    \"\"\"\n    # count the number of defendants in each group\n    grouped = cp.groupby(group_vars)\n    counts = grouped[\"id\"].count()\n\n    # make the table\n    columns = [\"FPR\", \"FNR\", \"PPV\", \"NPV\", \"Prevalence\"]\n    table = pd.DataFrame(index=counts.index, columns=columns, dtype=float)\n\n    # fill in the table\n    for name, group in grouped:\n        if len(group) < 50:\n            continue\n        m = make_matrix(group)\n        metrics = compute_metrics(m)\n        table.loc[name] = metrics[\"Percent\"]\n\n    table[\"Count\"] = counts\n    return table";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s the table for defendants grouped by race.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table1</span> <span class="o">=</span> <span class="n">make_table</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s2">&quot;race&quot;</span><span class="p">)</span>
<span class="n">table1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FPR</th>
      <th>FNR</th>
      <th>PPV</th>
      <th>NPV</th>
      <th>Prevalence</th>
      <th>Count</th>
    </tr>
    <tr>
      <th>race</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>African-American</th>
      <td>44.8</td>
      <td>28.0</td>
      <td>63.0</td>
      <td>65.0</td>
      <td>51.4</td>
      <td>3696</td>
    </tr>
    <tr>
      <th>Asian</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>32</td>
    </tr>
    <tr>
      <th>Caucasian</th>
      <td>23.5</td>
      <td>47.7</td>
      <td>59.1</td>
      <td>71.2</td>
      <td>39.4</td>
      <td>2454</td>
    </tr>
    <tr>
      <th>Hispanic</th>
      <td>21.5</td>
      <td>55.6</td>
      <td>54.2</td>
      <td>71.1</td>
      <td>36.4</td>
      <td>637</td>
    </tr>
    <tr>
      <th>Native American</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>18</td>
    </tr>
    <tr>
      <th>Other</th>
      <td>14.8</td>
      <td>67.7</td>
      <td>54.4</td>
      <td>69.8</td>
      <td>35.3</td>
      <td>377</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 5;
                var nbb_unformatted_code = "table1 = make_table(cp, \"race\")\ntable1";
                var nbb_formatted_code = "table1 = make_table(cp, \"race\")\ntable1";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Some rows contain <code class="docutils literal notranslate"><span class="pre">NaN</span></code> values because I did not compute metrics for groups with fewer than 50 defendants.</p>
<p><code class="docutils literal notranslate"><span class="pre">table1</span></code> confirms results from previous analysis and extends them to other groups:</p>
<ul class="simple">
<li><p>Predicive values are comparable for all racial groups, although PPV is highest for black defendants and NPV is lowest.</p></li>
<li><p>Error rates are substantially different in different groups.  FPR is highest for black defendants, lower for white and Hispanic defendants, and lowest for defendants in other racial groups.  FNR is highest for Other and lowest for African-American.</p></li>
</ul>
<p>The following table shows the breakdown by sex.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table2</span> <span class="o">=</span> <span class="n">make_table</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">)</span>
<span class="n">table2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FPR</th>
      <th>FNR</th>
      <th>PPV</th>
      <th>NPV</th>
      <th>Prevalence</th>
      <th>Count</th>
    </tr>
    <tr>
      <th>sex</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Female</th>
      <td>32.1</td>
      <td>39.2</td>
      <td>51.3</td>
      <td>75.7</td>
      <td>35.7</td>
      <td>1395</td>
    </tr>
    <tr>
      <th>Male</th>
      <td>32.4</td>
      <td>37.1</td>
      <td>63.5</td>
      <td>67.0</td>
      <td>47.3</td>
      <td>5819</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 6;
                var nbb_unformatted_code = "table2 = make_table(cp, \"sex\")\ntable2";
                var nbb_formatted_code = "table2 = make_table(cp, \"sex\")\ntable2";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Again, these results are consistent with previous analysis.  Comparing male and female defendants, the error rates are comparable, but the predictive values are substantially different.</p>
<p>Next we’ll look at the breakdown by age, but first I’ll recode the age categories so their ordering in the table is more logical:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span><span class="p">[</span><span class="s2">&quot;age_cat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;25 - 45&#39;, &#39;Greater than 45&#39;, &#39;Less than 25&#39;], dtype=&#39;object&#39;, name=&#39;age_cat&#39;)
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 7;
                var nbb_unformatted_code = "cp[\"age_cat\"].value_counts().index";
                var nbb_formatted_code = "cp[\"age_cat\"].value_counts().index";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Less than 25&quot;</span><span class="p">:</span> <span class="s2">&quot;1 Younger than 25&quot;</span><span class="p">,</span>
    <span class="s2">&quot;25 - 45&quot;</span><span class="p">:</span> <span class="s2">&quot;2 Between 25 - 45&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Greater than 45&quot;</span><span class="p">:</span> <span class="s2">&quot;3 Older than 45&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">cp</span><span class="p">[</span><span class="s2">&quot;age_cat_recode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="p">[</span><span class="s2">&quot;age_cat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 8;
                var nbb_unformatted_code = "d = {\n    \"Less than 25\": \"1 Younger than 25\",\n    \"25 - 45\": \"2 Between 25 - 45\",\n    \"Greater than 45\": \"3 Older than 45\",\n}\ncp[\"age_cat_recode\"] = cp[\"age_cat\"].replace(d)";
                var nbb_formatted_code = "d = {\n    \"Less than 25\": \"1 Younger than 25\",\n    \"25 - 45\": \"2 Between 25 - 45\",\n    \"Greater than 45\": \"3 Older than 45\",\n}\ncp[\"age_cat_recode\"] = cp[\"age_cat\"].replace(d)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s the breakdown by age group:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table3</span> <span class="o">=</span> <span class="n">make_table</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="s2">&quot;age_cat_recode&quot;</span><span class="p">)</span>
<span class="n">table3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FPR</th>
      <th>FNR</th>
      <th>PPV</th>
      <th>NPV</th>
      <th>Prevalence</th>
      <th>Count</th>
    </tr>
    <tr>
      <th>age_cat_recode</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1 Younger than 25</th>
      <td>54.1</td>
      <td>26.0</td>
      <td>64.0</td>
      <td>57.5</td>
      <td>56.5</td>
      <td>1529</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>33.4</td>
      <td>37.4</td>
      <td>61.5</td>
      <td>67.7</td>
      <td>46.0</td>
      <td>4109</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>16.8</td>
      <td>57.2</td>
      <td>54.1</td>
      <td>75.9</td>
      <td>31.6</td>
      <td>1576</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 9;
                var nbb_unformatted_code = "table3 = make_table(cp, \"age_cat_recode\")\ntable3";
                var nbb_formatted_code = "table3 = make_table(cp, \"age_cat_recode\")\ntable3";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>This table shows some patterns we have seen before</p>
<ul class="simple">
<li><p>In groups with high prevalence, FPR is relatively high and FNR relatively low.</p></li>
<li><p>In groups with high prevalence, PPV is relatively hight and NPV relatively low.</p></li>
</ul>
<p>But it is still not clear whether COMPAS is trying to achieve constant error rates, constant predictive values, or a compromise between the two.</p>
<p>It is also not clear what we can say about defendants in the intersections of these groups.  What are the metrics for a white male, or an older Hispanic defendant?</p>
<p>I’ll compute these intersections in the next section.</p>
</section>
<section id="intersections">
<h2>Intersections<a class="headerlink" href="#intersections" title="Link to this heading">#</a></h2>
<p>In this section I’ll compute metrics for defendants grouped by</p>
<ul class="simple">
<li><p>Race and sex</p></li>
<li><p>Race and age</p></li>
<li><p>Sex and age</p></li>
<li><p>Race, sex, and age</p></li>
</ul>
<p>Then we’ll plot the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table4</span> <span class="o">=</span> <span class="n">make_table</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;race&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">])</span>
<span class="n">table4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>FPR</th>
      <th>FNR</th>
      <th>PPV</th>
      <th>NPV</th>
      <th>Prevalence</th>
      <th>Count</th>
    </tr>
    <tr>
      <th>race</th>
      <th>sex</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">African-American</th>
      <th>Female</th>
      <td>40.5</td>
      <td>30.0</td>
      <td>51.3</td>
      <td>76.5</td>
      <td>37.9</td>
      <td>652</td>
    </tr>
    <tr>
      <th>Male</th>
      <td>46.1</td>
      <td>27.7</td>
      <td>65.1</td>
      <td>62.1</td>
      <td>54.3</td>
      <td>3044</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Asian</th>
      <th>Female</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2</td>
    </tr>
    <tr>
      <th>Male</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>30</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Caucasian</th>
      <th>Female</th>
      <td>30.2</td>
      <td>43.2</td>
      <td>50.4</td>
      <td>74.9</td>
      <td>35.1</td>
      <td>567</td>
    </tr>
    <tr>
      <th>Male</th>
      <td>21.2</td>
      <td>48.9</td>
      <td>62.2</td>
      <td>70.2</td>
      <td>40.6</td>
      <td>1887</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Hispanic</th>
      <th>Female</th>
      <td>10.0</td>
      <td>72.7</td>
      <td>56.2</td>
      <td>72.4</td>
      <td>32.0</td>
      <td>103</td>
    </tr>
    <tr>
      <th>Male</th>
      <td>23.9</td>
      <td>52.8</td>
      <td>54.0</td>
      <td>70.8</td>
      <td>37.3</td>
      <td>534</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Native American</th>
      <th>Female</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4</td>
    </tr>
    <tr>
      <th>Male</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>14</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Other</th>
      <th>Female</th>
      <td>11.5</td>
      <td>66.7</td>
      <td>45.5</td>
      <td>82.1</td>
      <td>22.4</td>
      <td>67</td>
    </tr>
    <tr>
      <th>Male</th>
      <td>15.6</td>
      <td>67.8</td>
      <td>55.9</td>
      <td>66.9</td>
      <td>38.1</td>
      <td>310</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 10;
                var nbb_unformatted_code = "table4 = make_table(cp, [\"race\", \"sex\"])\ntable4";
                var nbb_formatted_code = "table4 = make_table(cp, [\"race\", \"sex\"])\ntable4";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table5</span> <span class="o">=</span> <span class="n">make_table</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;race&quot;</span><span class="p">,</span> <span class="s2">&quot;age_cat_recode&quot;</span><span class="p">])</span>
<span class="n">table5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>FPR</th>
      <th>FNR</th>
      <th>PPV</th>
      <th>NPV</th>
      <th>Prevalence</th>
      <th>Count</th>
    </tr>
    <tr>
      <th>race</th>
      <th>age_cat_recode</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">African-American</th>
      <th>1 Younger than 25</th>
      <td>59.9</td>
      <td>23.2</td>
      <td>66.7</td>
      <td>52.6</td>
      <td>61.0</td>
      <td>920</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>44.1</td>
      <td>27.7</td>
      <td>62.7</td>
      <td>66.4</td>
      <td>50.6</td>
      <td>2194</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>31.8</td>
      <td>41.3</td>
      <td>54.7</td>
      <td>71.6</td>
      <td>39.5</td>
      <td>582</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Asian</th>
      <th>1 Younger than 25</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>14</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>11</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Caucasian</th>
      <th>1 Younger than 25</th>
      <td>48.7</td>
      <td>26.7</td>
      <td>59.1</td>
      <td>66.7</td>
      <td>49.0</td>
      <td>390</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>26.8</td>
      <td>47.0</td>
      <td>60.0</td>
      <td>67.2</td>
      <td>43.1</td>
      <td>1312</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>9.6</td>
      <td>68.9</td>
      <td>55.6</td>
      <td>77.3</td>
      <td>27.8</td>
      <td>752</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Hispanic</th>
      <th>1 Younger than 25</th>
      <td>47.5</td>
      <td>36.4</td>
      <td>59.2</td>
      <td>57.1</td>
      <td>52.0</td>
      <td>127</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>18.5</td>
      <td>59.3</td>
      <td>56.1</td>
      <td>70.3</td>
      <td>36.8</td>
      <td>367</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>13.4</td>
      <td>80.6</td>
      <td>28.6</td>
      <td>79.5</td>
      <td>21.7</td>
      <td>143</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Native American</th>
      <th>1 Younger than 25</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>12</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Other</th>
      <th>1 Younger than 25</th>
      <td>45.2</td>
      <td>47.5</td>
      <td>52.5</td>
      <td>54.8</td>
      <td>48.8</td>
      <td>82</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>10.8</td>
      <td>73.2</td>
      <td>55.9</td>
      <td>70.5</td>
      <td>33.8</td>
      <td>210</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>3.2</td>
      <td>86.4</td>
      <td>60.0</td>
      <td>76.2</td>
      <td>25.9</td>
      <td>85</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 11;
                var nbb_unformatted_code = "table5 = make_table(cp, [\"race\", \"age_cat_recode\"])\ntable5";
                var nbb_formatted_code = "table5 = make_table(cp, [\"race\", \"age_cat_recode\"])\ntable5";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table6</span> <span class="o">=</span> <span class="n">make_table</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;age_cat&quot;</span><span class="p">])</span>
<span class="n">table6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>FPR</th>
      <th>FNR</th>
      <th>PPV</th>
      <th>NPV</th>
      <th>Prevalence</th>
      <th>Count</th>
    </tr>
    <tr>
      <th>sex</th>
      <th>age_cat</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">Female</th>
      <th>25 - 45</th>
      <td>29.4</td>
      <td>40.8</td>
      <td>56.2</td>
      <td>73.1</td>
      <td>38.9</td>
      <td>807</td>
    </tr>
    <tr>
      <th>Greater than 45</th>
      <td>15.3</td>
      <td>66.2</td>
      <td>40.7</td>
      <td>80.5</td>
      <td>23.7</td>
      <td>300</td>
    </tr>
    <tr>
      <th>Less than 25</th>
      <td>61.7</td>
      <td>17.7</td>
      <td>46.3</td>
      <td>77.0</td>
      <td>39.2</td>
      <td>288</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Male</th>
      <th>25 - 45</th>
      <td>34.5</td>
      <td>36.7</td>
      <td>62.6</td>
      <td>66.2</td>
      <td>47.7</td>
      <td>3302</td>
    </tr>
    <tr>
      <th>Greater than 45</th>
      <td>17.2</td>
      <td>55.7</td>
      <td>56.4</td>
      <td>74.7</td>
      <td>33.5</td>
      <td>1276</td>
    </tr>
    <tr>
      <th>Less than 25</th>
      <td>51.4</td>
      <td>27.3</td>
      <td>68.4</td>
      <td>53.7</td>
      <td>60.5</td>
      <td>1241</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 12;
                var nbb_unformatted_code = "table6 = make_table(cp, [\"sex\", \"age_cat\"])\ntable6";
                var nbb_formatted_code = "table6 = make_table(cp, [\"sex\", \"age_cat\"])\ntable6";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table7</span> <span class="o">=</span> <span class="n">make_table</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;race&quot;</span><span class="p">,</span> <span class="s2">&quot;sex&quot;</span><span class="p">,</span> <span class="s2">&quot;age_cat_recode&quot;</span><span class="p">])</span>
<span class="n">table7</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th></th>
      <th>FPR</th>
      <th>FNR</th>
      <th>PPV</th>
      <th>NPV</th>
      <th>Prevalence</th>
      <th>Count</th>
    </tr>
    <tr>
      <th>race</th>
      <th>sex</th>
      <th>age_cat_recode</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="6" valign="top">African-American</th>
      <th rowspan="3" valign="top">Female</th>
      <th>1 Younger than 25</th>
      <td>63.4</td>
      <td>19.7</td>
      <td>50.8</td>
      <td>69.4</td>
      <td>45.0</td>
      <td>169</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>36.5</td>
      <td>34.4</td>
      <td>52.7</td>
      <td>74.9</td>
      <td>38.2</td>
      <td>395</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>23.5</td>
      <td>35.0</td>
      <td>44.8</td>
      <td>88.1</td>
      <td>22.7</td>
      <td>88</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Male</th>
      <th>1 Younger than 25</th>
      <td>58.6</td>
      <td>23.7</td>
      <td>70.3</td>
      <td>48.9</td>
      <td>64.6</td>
      <td>751</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>46.3</td>
      <td>26.6</td>
      <td>64.4</td>
      <td>63.9</td>
      <td>53.3</td>
      <td>1799</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>33.8</td>
      <td>41.9</td>
      <td>56.0</td>
      <td>68.1</td>
      <td>42.5</td>
      <td>494</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">Asian</th>
      <th rowspan="2" valign="top">Female</th>
      <th>2 Between 25 - 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Male</th>
      <th>1 Younger than 25</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>13</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>10</td>
    </tr>
    <tr>
      <th rowspan="6" valign="top">Caucasian</th>
      <th rowspan="3" valign="top">Female</th>
      <th>1 Younger than 25</th>
      <td>70.0</td>
      <td>3.7</td>
      <td>38.2</td>
      <td>94.7</td>
      <td>31.0</td>
      <td>87</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>29.2</td>
      <td>41.2</td>
      <td>59.7</td>
      <td>70.0</td>
      <td>42.4</td>
      <td>309</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>13.1</td>
      <td>75.6</td>
      <td>37.0</td>
      <td>78.5</td>
      <td>24.0</td>
      <td>171</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Male</th>
      <th>1 Younger than 25</th>
      <td>39.6</td>
      <td>30.5</td>
      <td>67.5</td>
      <td>62.7</td>
      <td>54.1</td>
      <td>303</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>26.1</td>
      <td>48.7</td>
      <td>60.1</td>
      <td>66.5</td>
      <td>43.4</td>
      <td>1003</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>8.5</td>
      <td>67.3</td>
      <td>61.1</td>
      <td>77.0</td>
      <td>28.9</td>
      <td>581</td>
    </tr>
    <tr>
      <th rowspan="6" valign="top">Hispanic</th>
      <th rowspan="3" valign="top">Female</th>
      <th>1 Younger than 25</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>17</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>7.1</td>
      <td>81.0</td>
      <td>57.1</td>
      <td>69.6</td>
      <td>33.3</td>
      <td>63</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>23</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Male</th>
      <th>1 Younger than 25</th>
      <td>52.9</td>
      <td>37.3</td>
      <td>57.8</td>
      <td>52.2</td>
      <td>53.6</td>
      <td>110</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>21.1</td>
      <td>55.3</td>
      <td>56.0</td>
      <td>70.4</td>
      <td>37.5</td>
      <td>304</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>13.8</td>
      <td>76.9</td>
      <td>31.6</td>
      <td>80.2</td>
      <td>21.7</td>
      <td>120</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">Native American</th>
      <th rowspan="2" valign="top">Female</th>
      <th>2 Between 25 - 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Male</th>
      <th>1 Younger than 25</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>10</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1</td>
    </tr>
    <tr>
      <th rowspan="6" valign="top">Other</th>
      <th rowspan="3" valign="top">Female</th>
      <th>1 Younger than 25</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>15</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>37</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>15</td>
    </tr>
    <tr>
      <th rowspan="3" valign="top">Male</th>
      <th>1 Younger than 25</th>
      <td>46.7</td>
      <td>45.9</td>
      <td>58.8</td>
      <td>48.5</td>
      <td>55.2</td>
      <td>67</td>
    </tr>
    <tr>
      <th>2 Between 25 - 45</th>
      <td>12.6</td>
      <td>75.8</td>
      <td>51.7</td>
      <td>67.4</td>
      <td>35.8</td>
      <td>173</td>
    </tr>
    <tr>
      <th>3 Older than 45</th>
      <td>3.9</td>
      <td>84.2</td>
      <td>60.0</td>
      <td>75.4</td>
      <td>27.1</td>
      <td>70</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 13;
                var nbb_unformatted_code = "table7 = make_table(cp, [\"race\", \"sex\", \"age_cat_recode\"])\ntable7";
                var nbb_formatted_code = "table7 = make_table(cp, [\"race\", \"sex\", \"age_cat_recode\"])\ntable7";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>These tables show how much these metrics vary between groups:</p>
<ul class="simple">
<li></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">table1</span><span class="p">,</span> <span class="n">table2</span><span class="p">,</span> <span class="n">table3</span><span class="p">,</span> <span class="n">table4</span><span class="p">,</span> <span class="n">table5</span><span class="p">,</span> <span class="n">table6</span><span class="p">,</span> <span class="n">table7</span><span class="p">]</span>

<span class="n">all_groups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">all_groups</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>81
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 14;
                var nbb_unformatted_code = "tables = [table1, table2, table3, table4, table5, table6, table7]\n\nall_groups = pd.concat(tables)\nlen(all_groups)";
                var nbb_formatted_code = "tables = [table1, table2, table3, table4, table5, table6, table7]\n\nall_groups = pd.concat(tables)\nlen(all_groups)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_groups</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FPR</th>
      <th>FNR</th>
      <th>PPV</th>
      <th>NPV</th>
      <th>Prevalence</th>
      <th>Count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>54.000000</td>
      <td>54.000000</td>
      <td>54.000000</td>
      <td>54.000000</td>
      <td>54.000000</td>
      <td>81.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>30.520370</td>
      <td>47.648148</td>
      <td>55.611111</td>
      <td>69.603704</td>
      <td>40.094444</td>
      <td>623.432099</td>
    </tr>
    <tr>
      <th>std</th>
      <td>17.339761</td>
      <td>19.922603</td>
      <td>8.655256</td>
      <td>9.204490</td>
      <td>10.987015</td>
      <td>1059.278516</td>
    </tr>
    <tr>
      <th>min</th>
      <td>3.200000</td>
      <td>3.700000</td>
      <td>28.600000</td>
      <td>48.500000</td>
      <td>21.700000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>15.375000</td>
      <td>31.475000</td>
      <td>52.550000</td>
      <td>66.425000</td>
      <td>33.350000</td>
      <td>15.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>29.300000</td>
      <td>44.550000</td>
      <td>56.200000</td>
      <td>70.250000</td>
      <td>38.550000</td>
      <td>169.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>45.100000</td>
      <td>66.575000</td>
      <td>60.850000</td>
      <td>75.625000</td>
      <td>48.525000</td>
      <td>652.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>70.000000</td>
      <td>86.400000</td>
      <td>70.300000</td>
      <td>94.700000</td>
      <td>64.600000</td>
      <td>5819.000000</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 15;
                var nbb_unformatted_code = "all_groups.describe()";
                var nbb_formatted_code = "all_groups.describe()";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">min_max_metric</span><span class="p">(</span><span class="n">all_groups</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">all_groups</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">all_groups</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">all_groups</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">all_groups</span><span class="p">[</span><span class="n">metric</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 16;
                var nbb_unformatted_code = "def min_max_metric(all_groups, metric):\n    \"\"\" \"\"\"\n    idx = all_groups[metric].idxmax()\n    print(idx, all_groups[metric][idx])\n\n    idx = all_groups[metric].idxmin()\n    print(idx, all_groups[metric][idx])";
                var nbb_formatted_code = "def min_max_metric(all_groups, metric):\n    \"\"\" \"\"\"\n    idx = all_groups[metric].idxmax()\n    print(idx, all_groups[metric][idx])\n\n    idx = all_groups[metric].idxmin()\n    print(idx, all_groups[metric][idx])";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here are the groups with maximumn and minimum FPR:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_max_metric</span><span class="p">(</span><span class="n">all_groups</span><span class="p">,</span> <span class="s2">&quot;FPR&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;Caucasian&#39;, &#39;Female&#39;, &#39;1 Younger than 25&#39;) 70.0
(&#39;Other&#39;, &#39;3 Older than 45&#39;) 3.2
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 17;
                var nbb_unformatted_code = "min_max_metric(all_groups, \"FPR\")";
                var nbb_formatted_code = "min_max_metric(all_groups, \"FPR\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>And here are the results for the other metrics:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_max_metric</span><span class="p">(</span><span class="n">all_groups</span><span class="p">,</span> <span class="s2">&quot;FNR&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;Other&#39;, &#39;3 Older than 45&#39;) 86.4
(&#39;Caucasian&#39;, &#39;Female&#39;, &#39;1 Younger than 25&#39;) 3.7
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 18;
                var nbb_unformatted_code = "min_max_metric(all_groups, \"FNR\")";
                var nbb_formatted_code = "min_max_metric(all_groups, \"FNR\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_max_metric</span><span class="p">(</span><span class="n">all_groups</span><span class="p">,</span> <span class="s2">&quot;PPV&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;African-American&#39;, &#39;Male&#39;, &#39;1 Younger than 25&#39;) 70.3
(&#39;Hispanic&#39;, &#39;3 Older than 45&#39;) 28.6
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 19;
                var nbb_unformatted_code = "min_max_metric(all_groups, \"PPV\")";
                var nbb_formatted_code = "min_max_metric(all_groups, \"PPV\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_max_metric</span><span class="p">(</span><span class="n">all_groups</span><span class="p">,</span> <span class="s2">&quot;NPV&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;Caucasian&#39;, &#39;Female&#39;, &#39;1 Younger than 25&#39;) 94.7
(&#39;Other&#39;, &#39;Male&#39;, &#39;1 Younger than 25&#39;) 48.5
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 20;
                var nbb_unformatted_code = "min_max_metric(all_groups, \"NPV\")";
                var nbb_formatted_code = "min_max_metric(all_groups, \"NPV\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_max_metric</span><span class="p">(</span><span class="n">all_groups</span><span class="p">,</span> <span class="s2">&quot;Prevalence&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&#39;African-American&#39;, &#39;Male&#39;, &#39;1 Younger than 25&#39;) 64.6
(&#39;Hispanic&#39;, &#39;3 Older than 45&#39;) 21.7
</pre></div>
</div>
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 21;
                var nbb_unformatted_code = "min_max_metric(all_groups, \"Prevalence\")";
                var nbb_formatted_code = "min_max_metric(all_groups, \"Prevalence\")";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Looking at these results, I have a few thoughts:</p>
<ol class="arabic simple">
<li><p>The differences between groups are big.  FNR, which ranges from about 4% to 86%, is particularly striking.</p></li>
<li><p>For some metrics the most extreme groups are relatively small groups, so that might not be meaningful.  Statistically it is easier for a small group to deviate from the overall averages.</p></li>
<li><p>It is not clear from these results how much of the variation between groups is due to differences in prevalance.  I’ll explore this relationship in the next section.</p></li>
</ol>
</section>
<section id="reverse-engineering">
<h2>Reverse engineering<a class="headerlink" href="#reverse-engineering" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">predictive_value</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">error_rates</span>

<span class="n">matrix_all</span> <span class="o">=</span> <span class="n">make_matrix</span><span class="p">(</span><span class="n">cp</span><span class="p">)</span>
<span class="n">ppv</span><span class="p">,</span> <span class="n">npv</span> <span class="o">=</span> <span class="n">predictive_value</span><span class="p">(</span><span class="n">matrix_all</span><span class="p">)</span>
<span class="n">fpr</span><span class="p">,</span> <span class="n">fnr</span> <span class="o">=</span> <span class="n">error_rates</span><span class="p">(</span><span class="n">matrix_all</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 22;
                var nbb_unformatted_code = "from utils import predictive_value\nfrom utils import error_rates\n\nmatrix_all = make_matrix(cp)\nppv, npv = predictive_value(matrix_all)\nfpr, fnr = error_rates(matrix_all)";
                var nbb_formatted_code = "from utils import predictive_value\nfrom utils import error_rates\n\nmatrix_all = make_matrix(cp)\nppv, npv = predictive_value(matrix_all)\nfpr, fnr = error_rates(matrix_all)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">constant_error_rates</span>

<span class="n">prevalences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

<span class="n">pred_pv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ppv&quot;</span><span class="p">,</span> <span class="s2">&quot;npv&quot;</span><span class="p">])</span>

<span class="k">for</span> <span class="n">prev</span> <span class="ow">in</span> <span class="n">prevalences</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">constant_error_rates</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">fnr</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span>
    <span class="n">pred_pv</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prev</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictive_value</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="n">pred_pv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ppv</th>
      <th>npv</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>20.0</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
    <tr>
      <th>24.5</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
    <tr>
      <th>29.0</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
    <tr>
      <th>33.5</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
    <tr>
      <th>38.0</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
    <tr>
      <th>42.5</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
    <tr>
      <th>47.0</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
    <tr>
      <th>51.5</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
    <tr>
      <th>56.0</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
    <tr>
      <th>60.5</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
    <tr>
      <th>65.0</th>
      <td>62.596124</td>
      <td>67.65077</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 23;
                var nbb_unformatted_code = "import numpy as np\nfrom utils import constant_error_rates\n\nprevalences = np.linspace(20, 65, 11)\n\npred_pv = pd.DataFrame(columns=[\"ppv\", \"npv\"])\n\nfor prev in prevalences:\n    m = constant_error_rates(fpr, fnr, prev)\n    pred_pv.loc[prev] = predictive_value(m)\n\npred_pv";
                var nbb_formatted_code = "import numpy as np\nfrom utils import constant_error_rates\n\nprevalences = np.linspace(20, 65, 11)\n\npred_pv = pd.DataFrame(columns=[\"ppv\", \"npv\"])\n\nfor prev in prevalences:\n    m = constant_error_rates(fpr, fnr, prev)\n    pred_pv.loc[prev] = predictive_value(m)\n\npred_pv";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">constant_predictive_value</span>

<span class="n">prevalences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>

<span class="n">pred_er</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;FPR&quot;</span><span class="p">,</span> <span class="s2">&quot;FNR&quot;</span><span class="p">])</span>

<span class="k">for</span> <span class="n">prev</span> <span class="ow">in</span> <span class="n">prevalences</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">constant_predictive_value</span><span class="p">(</span><span class="n">ppv</span><span class="p">,</span> <span class="n">npv</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span>
    <span class="n">pred_er</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prev</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_rates</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

<span class="n">pred_er</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FPR</th>
      <th>FNR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>35.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
    <tr>
      <th>37.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
    <tr>
      <th>39.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
    <tr>
      <th>41.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
    <tr>
      <th>43.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
    <tr>
      <th>45.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
    <tr>
      <th>47.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
    <tr>
      <th>49.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
    <tr>
      <th>51.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
    <tr>
      <th>53.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
    <tr>
      <th>55.0</th>
      <td>31.20349</td>
      <td>38.649382</td>
    </tr>
  </tbody>
</table>
</div></div><script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 24;
                var nbb_unformatted_code = "from utils import constant_predictive_value\n\nprevalences = np.linspace(35, 55, 11)\n\npred_er = pd.DataFrame(columns=[\"FPR\", \"FNR\"])\n\nfor prev in prevalences:\n    m = constant_predictive_value(ppv, npv, prev)\n    pred_er.loc[prev] = error_rates(m)\n\npred_er";
                var nbb_formatted_code = "from utils import constant_predictive_value\n\nprevalences = np.linspace(35, 55, 11)\n\npred_er = pd.DataFrame(columns=[\"FPR\", \"FNR\"])\n\nfor prev in prevalences:\n    m = constant_predictive_value(ppv, npv, prev)\n    pred_er.loc[prev] = error_rates(m)\n\npred_er";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">plot_cpv_model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 25;
                var nbb_unformatted_code = "from utils import plot_cpv_model";
                var nbb_formatted_code = "from utils import plot_cpv_model";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">plot_cer_model</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 26;
                var nbb_unformatted_code = "from utils import plot_cer_model";
                var nbb_formatted_code = "from utils import plot_cer_model";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Those are all the possible subgroups for these three variables.</p>
<p>Now we can see what the results look like.</p>
<p>The following function plots one data point per subgroup showing the given metric versus prevalence.</p>
<p>Groups with a small number of people are shown with lighter colors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="k">def</span> <span class="nf">plot_table_var</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot one data point per row.</span>

<span class="sd">    table: DataFrame</span>
<span class="sd">    var: which metric to plot</span>
<span class="sd">    color: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;Prevalence&quot;</span><span class="p">],</span> <span class="n">table</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 27;
                var nbb_unformatted_code = "import matplotlib.pyplot as plt\n\n\ndef plot_table_var(table, var, color):\n    \"\"\"Plot one data point per row.\n\n    table: DataFrame\n    var: which metric to plot\n    color: string\n    \"\"\"\n    plt.plot(table[\"Prevalence\"], table[var], \"o\", color=color, alpha=0.6)";
                var nbb_formatted_code = "import matplotlib.pyplot as plt\n\n\ndef plot_table_var(table, var, color):\n    \"\"\"Plot one data point per row.\n\n    table: DataFrame\n    var: which metric to plot\n    color: string\n    \"\"\"\n    plt.plot(table[\"Prevalence\"], table[var], \"o\", color=color, alpha=0.6)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Here’s what the results look like for FPR.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">decorate</span>

<span class="n">pred_er</span><span class="p">[</span><span class="s2">&quot;FPR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected FPR, constant PV&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected FPR, constant ER&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
    <span class="n">plot_table_var</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;FPR&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Prevalence&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;False positive rate&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;False positive rates by subgroup&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/77c8740d1c2540c0ed8d3da4ee0e70de62957bca6ecfe7bb4b63c47f2216910d.png" src="_images/77c8740d1c2540c0ed8d3da4ee0e70de62957bca6ecfe7bb4b63c47f2216910d.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 28;
                var nbb_unformatted_code = "from utils import decorate\n\npred_er[\"FPR\"].plot(label=\"Expected FPR, constant PV\", color=\"C2\")\nplt.axhline(fpr, linestyle=\"dotted\", color=\"gray\", label=\"Expected FPR, constant ER\")\n\nfor table in tables:\n    plot_table_var(table, \"FPR\", \"C2\")\n\ndecorate(\n    xlabel=\"Prevalence\",\n    ylabel=\"False positive rate\",\n    title=\"False positive rates by subgroup\",\n)";
                var nbb_formatted_code = "from utils import decorate\n\npred_er[\"FPR\"].plot(label=\"Expected FPR, constant PV\", color=\"C2\")\nplt.axhline(fpr, linestyle=\"dotted\", color=\"gray\", label=\"Expected FPR, constant ER\")\n\nfor table in tables:\n    plot_table_var(table, \"FPR\", \"C2\")\n\ndecorate(\n    xlabel=\"Prevalence\",\n    ylabel=\"False positive rate\",\n    title=\"False positive rates by subgroup\",\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_er</span><span class="p">[</span><span class="s2">&quot;FNR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected FNR, constant PV&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C4&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">fnr</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected FNR, constant ER&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
    <span class="n">plot_table_var</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;FNR&quot;</span><span class="p">,</span> <span class="s2">&quot;C4&quot;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Prevalence&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;False negative rate&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;False negative rates by subgroup&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/3a0a963e1d9012cc04e13c760b3a5d6fb2289f66630d8cee4257cb7cb0a1c674.png" src="_images/3a0a963e1d9012cc04e13c760b3a5d6fb2289f66630d8cee4257cb7cb0a1c674.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 29;
                var nbb_unformatted_code = "pred_er[\"FNR\"].plot(label=\"Expected FNR, constant PV\", color=\"C4\")\nplt.axhline(fnr, linestyle=\"dotted\", color=\"gray\", label=\"Expected FNR, constant ER\")\n\nfor table in tables:\n    plot_table_var(table, \"FNR\", \"C4\")\n\ndecorate(\n    xlabel=\"Prevalence\",\n    ylabel=\"False negative rate\",\n    title=\"False negative rates by subgroup\",\n)";
                var nbb_formatted_code = "pred_er[\"FNR\"].plot(label=\"Expected FNR, constant PV\", color=\"C4\")\nplt.axhline(fnr, linestyle=\"dotted\", color=\"gray\", label=\"Expected FNR, constant ER\")\n\nfor table in tables:\n    plot_table_var(table, \"FNR\", \"C4\")\n\ndecorate(\n    xlabel=\"Prevalence\",\n    ylabel=\"False negative rate\",\n    title=\"False negative rates by subgroup\",\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>In general, groups with higher prevalence have higher false positive rates, but the effect is less extreme than what we would expect from the CPV model.</p>
<p>Here are the results for positive predictive value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_pv</span><span class="p">[</span><span class="s2">&quot;ppv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected PPV, constant FPR&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">ppv</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected PPV, constant PPV&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
    <span class="n">plot_table_var</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;PPV&quot;</span><span class="p">,</span> <span class="s2">&quot;C0&quot;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Prevalence&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Positive predictive value&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Positive predictive value by subgroup&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/763fc2f97cd6a618f9b2b359f8c9dce428e760904c625e64c41a1b66bab5ac1e.png" src="_images/763fc2f97cd6a618f9b2b359f8c9dce428e760904c625e64c41a1b66bab5ac1e.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 30;
                var nbb_unformatted_code = "pred_pv[\"ppv\"].plot(label=\"Expected PPV, constant FPR\", color=\"C0\")\nplt.axhline(ppv, linestyle=\"dotted\", color=\"gray\", label=\"Expected PPV, constant PPV\")\n\nfor table in tables:\n    plot_table_var(table, \"PPV\", \"C0\")\n\ndecorate(\n    xlabel=\"Prevalence\",\n    ylabel=\"Positive predictive value\",\n    title=\"Positive predictive value by subgroup\",\n)";
                var nbb_formatted_code = "pred_pv[\"ppv\"].plot(label=\"Expected PPV, constant FPR\", color=\"C0\")\nplt.axhline(ppv, linestyle=\"dotted\", color=\"gray\", label=\"Expected PPV, constant PPV\")\n\nfor table in tables:\n    plot_table_var(table, \"PPV\", \"C0\")\n\ndecorate(\n    xlabel=\"Prevalence\",\n    ylabel=\"Positive predictive value\",\n    title=\"Positive predictive value by subgroup\",\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Groups with higher prevalence have higher PPV, but the effect is less extreme than we would expect from the CPV model.</p>
<p>Here are the results for false negative rate.</p>
<p>Groups with higher prevalence have lower FNR, but the effect is less extreme than we would expect from the CPV model.</p>
<p>Here are the results for negative predictive value.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pred_pv</span><span class="p">[</span><span class="s2">&quot;npv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected NPV, constant FPR&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">npv</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected NPV, constant NPV&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
    <span class="n">plot_table_var</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;NPV&quot;</span><span class="p">,</span> <span class="s2">&quot;C1&quot;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Prevalence&quot;</span><span class="p">,</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Negative predictive value&quot;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Negative predictive value by subgroup&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/1d3ecd8a580f63ebd8985fe017ea40ad16428f39f0b3a6294f13f3523d54b375.png" src="_images/1d3ecd8a580f63ebd8985fe017ea40ad16428f39f0b3a6294f13f3523d54b375.png" />
<script type="application/javascript">
            setTimeout(function() {
                var nbb_cell_id = 31;
                var nbb_unformatted_code = "pred_pv[\"npv\"].plot(label=\"Expected NPV, constant FPR\", color=\"C1\")\nplt.axhline(npv, linestyle=\"dotted\", color=\"gray\", label=\"Expected NPV, constant NPV\")\n\nfor table in tables:\n    plot_table_var(table, \"NPV\", \"C1\")\n\ndecorate(\n    xlabel=\"Prevalence\",\n    ylabel=\"Negative predictive value\",\n    title=\"Negative predictive value by subgroup\",\n)";
                var nbb_formatted_code = "pred_pv[\"npv\"].plot(label=\"Expected NPV, constant FPR\", color=\"C1\")\nplt.axhline(npv, linestyle=\"dotted\", color=\"gray\", label=\"Expected NPV, constant NPV\")\n\nfor table in tables:\n    plot_table_var(table, \"NPV\", \"C1\")\n\ndecorate(\n    xlabel=\"Prevalence\",\n    ylabel=\"Negative predictive value\",\n    title=\"Negative predictive value by subgroup\",\n)";
                var nbb_cells = Jupyter.notebook.get_cells();
                for (var i = 0; i < nbb_cells.length; ++i) {
                    if (nbb_cells[i].input_prompt_number == nbb_cell_id) {
                        if (nbb_cells[i].get_text() == nbb_unformatted_code) {
                             nbb_cells[i].set_text(nbb_formatted_code);
                        }
                        break;
                    }
                }
            }, 500);
            </script></div>
</div>
<p>Groups with higher prevalence have lower NPV.  In this case, the effect is almost exactly what we would expect from the CPV model.</p>
<p>Part of a <a class="reference external" href="https://allendowney.github.io/RecidivismCaseStudy/">Recidivism Case Study</a></p>
<p>by <a class="reference external" href="https://allendowney.com">Allen Downey</a></p>
<p><a class="reference external" href="https://creativecommons.org/licenses/by-nc/4.0/">Attribution-NonCommercial 4.0 International (CC BY-NC 4.0)</a></p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data">Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-reference-class-problem">The reference class problem</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#groups">Groups</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#intersections">Intersections</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#reverse-engineering">Reverse engineering</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Allen B. Downey
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>